#!/bin/sh
#
# Sync all branches to Linus latest
#

. ~/bin/tip/tip-lib

check_master

# Linus branch is the reference
git-checkout linus
git-pull || exit 1;
git-checkout master

AB=`get_auto_branches`
BS=`git branch | sed "s/\* //"`

for B in $BS
do
    # Exclude autogenerated branches
    EXP=1
    for A in $AB
    do
	if [ "$A" == "$B" ]
	then 
	    EXP=0; 
	    break;
	fi
    done

    if [ $EXP -eq 0 ]
    then
	echo "Skipping autogenerated branch $B"
	continue;
    fi

    echo "Updating $B"
    git-checkout $B
    # check whether there's anything to pull from the origin:
    echo "Pulling from origin"
    git-pull
    git-merge linus  || {

	echo Merging $B failed
	echo merge conflict - run tip-mergetool
	echo
	echo running subshell - type "exit" when resolved
	$SHELL || abort_merge

	NCOM=`git-ls-files -u`
	if [ ! -z "$NCOM" ]
	then
	    echo "Merge was not committed! Fixing it up"
	    git-add $(git-ls-files -u | cut -f2 | sort | uniq)
	    git-commit -s || abort_merge;
	fi
    }
done

# switch back to master again
git-checkout master
